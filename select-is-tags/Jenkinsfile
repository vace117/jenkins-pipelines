import groovy.json.JsonSlurper

def availableTags = ""

/**
 * Returns a list of '\n' separated tags available in the specified image stream
 */
String fetchImageStreamTags(String imageStreamName) {
    // Get ImageStream data in JSON format
    //
    String result = sh(
      returnStdout: true, 
      script: "oc get is ${imageStreamName} -o json".toString()
    )

    // Parse JSON
    //
    def json = new JsonSlurper().parseText(result)
    if ( json.spec.tags?.isEmpty() ) {
      error("Unable to fetch tags from '${imageStreamName}' ImageStream, in Project '${env.PROJECT_NAME}'")
    }
    else {
      String parsedOutTags = json.spec.tags.collect { it.name }.join('\n')
      
      echo """
      ========= Available Tags =========
      ${parsedOutTags}
      ==================================
      """

      return parsedOutTags
    }


    // if (json.spec.tags == null || json.spec.tags.size == 0) {
    //   availableTags.add("unable to fetch tags for pipeline-tags")
    // } else {
    //   json.spec.tags.each { availableTags.add(it.name) }
    // }
    // return availableTags.join('\n')
}

try {
  node {
    stage("Get Tags") {
      timeout(time: 20, unit: 'SECONDS') {
        openshift.withCluster() {
          openshift.withProject(env.PROJECT_NAME) {
            String availableTags = fetchImageStreamTags(env.IMAGE_STREAM)
          }
        }  
      }
    }
    stage("Get User Input") {
        timeout(time: 5, unit: 'MINUTES') {
          echo "Waiting for user to select a tag..."

            // Show the select input modal
          String selectedTag = input(message: 'Please Provide Parameters', ok: 'Next', parameters: 
            [
              choice(name: 'IMAGE_TAG', choices: availableTags, description: 'Available Versions')
            ]
          )

          echo "============================="
          echo "User selected: ${selectedTag}"
          echo "============================="
          
          env.IMAGE_TAG = selectedTag
        }
    }
    stage("Use Input") {
        echo "User input: ${env.IMAGE_TAG}"
    }
  }
} catch (err) {
  echo "in catch block"
  echo "Caught: ${err}"
  currentBuild.result = 'FAILURE'
  throw err
}